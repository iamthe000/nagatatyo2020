<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<link rel="apple-touch-icon" sizes="192x192" href="icon192x192.png">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>æ°¸ç”°ç”ºãƒãƒˆãƒ«2020</title>
<style>
    body {
        font-family: sans-serif;
        background-color: #fff;
        color: #000;
        max-width: 700px;
        margin: 20px auto;
        padding: 10px;
        border: 1px solid #000;
    }
    h1, h2 {
        margin-bottom: 10px;
        border-bottom: 2px solid #000;
        padding-bottom: 5px;
    }

    .stats-panel {
        display: flex;
        justify-content: space-between;
        gap: 10px;
        margin-bottom: 20px;
        padding: 10px;
        border: 1px solid #000;
    }
    .stat-card {
        text-align: center;
        flex-grow: 1;
        padding: 5px;
        border-left: 1px dashed #666;
    }
    .stat-card:first-child { border-left: none; }
    .stat-card div:first-child {
        font-size: 0.8em;
        color: #333;
    }
    .stat-card .value {
        font-size: 2em;
        font-weight: bold;
    }

    .seat-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(8px, 1fr));
        gap: 1px;
        border: 1px solid #000;
        padding: 3px;
        background-color: #eee;
        margin-bottom: 20px;
    }
    .seat {
        width: 100%;
        aspect-ratio: 1;
    }
    .seat.player { background-color: #f00; }
    .seat.bot { background-color: #00f; }
    .seat.neutral { background-color: #ccc; }

    .policy-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
        gap: 10px;
        margin-bottom: 20px;
    }
    .policy-card {
        background-color: #fff;
        border: 2px solid #000;
        padding: 10px;
        cursor: pointer;
        font-size: 1em;
        font-weight: bold;
        text-align: center;
        transition: background-color 0.1s;
    }
    .policy-card:hover {
        background-color: #ddd;
    }
    .policy-card.attack {
        border-style: dashed;
    }

    .log-container {
        height: 150px;
        overflow-y: auto;
        border: 1px solid #000;
        background-color: #f9f9f9;
        padding: 8px;
        font-size: 0.85em;
    }

    .dialog-box {
        display: flex;
        align-items: flex-start;
        margin: 8px 0;
    }
    .character-img {
        width: 40px;
        height: 40px;
        border: 1px solid #000;
        margin-right: 8px;
        object-fit: cover;
        flex-shrink: 0;
    }
    .dialog-box.bot-dialog .character-img {
        margin-right: 0;
        margin-left: 8px;
    }
    .speech {
        position: relative;
        background: #fff;
        border: 1px solid #000;
        padding: 6px;
        max-width: calc(100% - 56px);
        line-height: 1.3;
    }
    .speech.bot {
        background: #eee;
    }

    .game-over {
        position: fixed; top: 0; left: 0;
        width: 100%; height: 100%;
        background: rgba(255, 255, 255, 0.95);
        display: none; justify-content: center; align-items: center;
        z-index: 1000;
    }
    .game-over-content {
        background: #fff;
        padding: 30px;
        border: 3px solid #000;
        text-align: center;
    }
    button {
        padding: 10px 20px;
        background: #000;
        color: #fff;
        border: none;
        cursor: pointer;
        font-size: 1em;
        font-weight: bold;
        transition: background-color 0.1s;
    }
    button:hover {
        background-color: #333;
    }

    .bgm-toggle {
        background: #ffa500;
        color: #000;
        border: 2px solid #000;
        font-weight: bold;
        padding: 6px 12px;
        cursor: pointer;
        margin-bottom: 10px;
    }
    .bgm-toggle:hover {
        background: #ffbf40;
    }
</style>
</head>
<body>

<div class="container">
    <div class="header">
        <h1>æ°¸ç”°ç”ºãƒãƒˆãƒ«2020</h1>
        <p>å…¨è­°å¸­(465)ã‚’åŸ‹ã‚å°½ãã›ï¼</p>
        <button class="bgm-toggle" id="bgmButton" onclick="toggleBGM()">ğŸµ BGMã‚ªãƒ³</button>
        <audio id="bgm" src="bgm.mp3" loop></audio>
    </div>

    <div class="stats-panel">
        <div class="stat-card"><div>ã‚ãªãŸ</div><div class="value" id="playerSeats">0</div></div>
        <div class="stat-card"><div>é‡å…š</div><div class="value" id="botSeats">0</div></div>
        <div class="stat-card"><div>æ®‹ã‚Š</div><div class="value" id="neutralSeats">465</div></div>
        <div class="stat-card"><div>ã‚¿ãƒ¼ãƒ³</div><div class="value" id="turnCount">1</div></div>
    </div>

    <h2>è­°å¸­çŠ¶æ³</h2>
    <div class="seat-grid" id="seatGrid"></div>

    <h2>æ”¿ç­–</h2>
    <div class="policy-grid" id="policyGrid"></div>

    <h2>ãƒ­ã‚°</h2>
    <div class="log-container" id="logContainer"></div>
</div>

<div class="game-over" id="gameOver">
    <div class="game-over-content">
        <h2 id="resultTitle"></h2>
        <button onclick="restartGame()">ãƒªã‚¹ã‚¿ãƒ¼ãƒˆ</button>
    </div>
</div>

<script>
const TOTAL_SEATS = 465;
const policies = [
    { id: 0, name: "çµŒæ¸ˆå¯¾ç­–", base: 45 },
    { id: 1, name: "æ•™è‚²æ”¹é©", base: 35 },
    { id: 2, name: "åŒ»ç™‚å……å®Ÿ", base: 40 },
    { id: 3, name: "é˜²è¡›å¼·åŒ–", base: 38 },
    { id: 4, name: "ç’°å¢ƒæ”¿ç­–", base: 32 },
    { id: 5, name: "å­è‚²ã¦æ”¯æ´", base: 30 },
    { id: 6, name: "åœ°æ–¹å‰µç”Ÿ", base: 28 },
    { id: 7, name: "ã‚¹ã‚­ãƒ£ãƒ³ãƒ€ãƒ«æš´éœ²", base: 25, attack: true },
    { id: 8, name: "ãƒ¡ãƒ‡ã‚£ã‚¢æ“ä½œ", base: 22, attack: true },
];

let gameState;
let seatElements = [];
let bgmEnabled = false;

function createInitialState() {
    return {
        playerSeats: 10,
        botSeats: 10,
        neutralSeats: TOTAL_SEATS - 20,
        turn: 1,
        isPlayerTurn: true,
        policyUsage: {},
    };
}

function init() {
    gameState = createInitialState();
    document.getElementById('logContainer').innerHTML = '';
    document.getElementById('gameOver').style.display = 'none';

    const seatGrid = document.getElementById('seatGrid');
    seatGrid.innerHTML = '';
    seatElements = [];
    for (let i = 0; i < TOTAL_SEATS; i++) {
        const seat = document.createElement('div');
        seat.className = 'seat neutral';
        seatGrid.appendChild(seat);
        seatElements.push(seat);
    }

    const policyGrid = document.getElementById('policyGrid');
    policyGrid.innerHTML = '';
    policies.forEach(policy => {
        const card = document.createElement('div');
        card.className = 'policy-card';
        if (policy.attack) card.classList.add('attack');
        card.textContent = policy.name;
        card.onclick = () => selectPolicy(policy.id);
        policyGrid.appendChild(card);
    });

    let idx = 0;
    for (let i = 0; i < gameState.playerSeats; i++) seatElements[idx++].classList.replace('neutral', 'player');
    for (let i = 0; i < gameState.botSeats; i++) seatElements[idx++].classList.replace('neutral', 'bot');

    updateDisplay();
    addDialog("player", "ä½œæˆ¦é–‹å§‹ã â€¦ã“ã®å›½ã‚’å‹•ã‹ã™ã®ã¯ä¿ºã ï¼");
}

function calcEffect(id) {
    const policy = policies.find(p => p.id === id);
    const used = gameState.policyUsage[id] || 0;
    const factor = Math.pow(0.8, used);
    return Math.max(3, Math.round(policy.base * factor));
}

function selectPolicy(id) {
    if (!gameState.isPlayerTurn) return;
    const p = policies.find(p => p.id === id);
    const e = calcEffect(id);
    gameState.policyUsage[id] = (gameState.policyUsage[id] || 0) + 1;

    if (p.attack) {
        const s = Math.min(e, gameState.botSeats);
        if (s > 0) {
            gameState.playerSeats += s;
            gameState.botSeats -= s;
            updateSeats('bot', 'player', s);
            addDialog("player", `${p.name}ã§é‡å…šã‹ã‚‰${s}è­°å¸­ã‚’å¥ªã£ãŸï¼`);
        } else addDialog("player", `${p.name}ã‚’ä½¿ã£ãŸãŒåŠ¹æœã¯ãªã‹ã£ãŸâ€¦`);
    } else {
        const g = Math.min(e, gameState.neutralSeats);
        if (g > 0) {
            gameState.playerSeats += g;
            gameState.neutralSeats -= g;
            updateSeats('neutral', 'player', g);
            addDialog("player", `${p.name}ã§${g}è­°å¸­ã‚’ç²å¾—ï¼`);
        } else addDialog("player", `${p.name}ã®åŠ¹æœã¯ã‚‚ã†ãªã„ã‚ˆã†ã â€¦`);
    }

    endTurn();
    setTimeout(botTurn, 1500);
}

function botTurn() {
    if (checkGameOver()) return;
    const p = policies[Math.floor(Math.random() * policies.length)];
    const e = calcEffect(p.id);
    gameState.policyUsage[p.id] = (gameState.policyUsage[p.id] || 0) + 1;

    if (p.attack) {
        const s = Math.min(e, gameState.playerSeats);
        if (s > 0) {
            gameState.botSeats += s;
            gameState.playerSeats -= s;
            updateSeats('player', 'bot', s);
            addDialog("bot", `${p.name}ã§å›ã‹ã‚‰${s}è­°å¸­ã‚’å¥ªã£ãŸï¼`);
        } else addDialog("bot", `${p.name}ã‚’ä½¿ã£ãŸãŒåŠ¹æœã¯ãªã‹ã£ãŸâ€¦`);
    } else {
        const g = Math.min(e, gameState.neutralSeats);
        if (g > 0) {
            gameState.botSeats += g;
            gameState.neutralSeats -= g;
            updateSeats('neutral', 'bot', g);
            addDialog("bot", `${p.name}ã§${g}è­°å¸­ã‚’ç²å¾—ï¼`);
        } else addDialog("bot", `${p.name}ã®åŠ¹æœã¯ã‚‚ã†ãªã„â€¦`);
    }

    endTurn(true);
}

/* ğŸ¤ å¤±è¨€ã‚¤ãƒ™ãƒ³ãƒˆ */
function checkForSlipEvent() {
    // 20%ã®ç¢ºç‡ã§ç™ºå‹•
    if (Math.random() < 0.2 && gameState.playerSeats > 5) {
        const phrases = ["ç§ã¯ãƒªã‚¹ãƒˆã‚’è¦‹ã¦ã„ãªã„", "ã‚¬ãƒ¼ã‚¹ãƒ¼ã§ã™"];
        const line = phrases[Math.floor(Math.random() * phrases.length)];
        addDialog("player", line);
        setTimeout(() => {
            addDialog("player", "ã—ã¾ã£ãŸã€ã¾ãŸå¤±è¨€ã—ã¦ã—ã¾ã£ãŸâ€¦");
            const loss = Math.floor(Math.random() * 8) + 3; // 3ã€œ10è­°å¸­æ¸›
            const actualLoss = Math.min(loss, gameState.playerSeats);
            gameState.playerSeats -= actualLoss;
            gameState.neutralSeats += actualLoss;
            updateSeats('player', 'neutral', actualLoss);
            updateDisplay();
            addDialog("bot", `å¤±è¨€ã§${actualLoss}è­°å¸­ãŒé›¢ã‚ŒãŸã‚ˆã†ã ãªâ€¦`);
            checkGameOver();
        }, 1000);
    }
}

function endTurn(isBot = false) {
    if (isBot) {
        gameState.turn++;
        gameState.isPlayerTurn = true;
    } else {
        gameState.isPlayerTurn = false;
    }
    updateDisplay();
    checkGameOver();
    if (!isBot) checkForSlipEvent(); // ğŸ¤ è‡ªåˆ†ã®ã‚¿ãƒ¼ãƒ³å¾Œã«ç™ºå‹•åˆ¤å®š
}

function updateSeats(from, to, n) {
    const c = seatElements.filter(s => s.classList.contains(from));
    for (let i = 0; i < n && c.length; i++) {
        const r = Math.floor(Math.random() * c.length);
        const s = c[r];
        s.classList.remove(from);
        s.classList.add(to);
        c.splice(r, 1);
    }
}

function updateDisplay() {
    document.getElementById('playerSeats').textContent = gameState.playerSeats;
    document.getElementById('botSeats').textContent = gameState.botSeats;
    document.getElementById('neutralSeats').textContent = gameState.neutralSeats;
    document.getElementById('turnCount').textContent = gameState.turn;
}

function addDialog(speaker, text) {
    const container = document.getElementById('logContainer');
    const div = document.createElement('div');
    div.className = 'dialog-box' + (speaker === "bot" ? " bot-dialog" : "");
    const img = document.createElement('img');
    img.className = 'character-img';
    img.src = speaker === "player" ? "zimin.png" : "minsyu.png";
    const speech = document.createElement('div');
    speech.className = 'speech' + (speaker === "bot" ? " bot" : "");
    speech.textContent = text;
    if (speaker === "bot") { div.appendChild(speech); div.appendChild(img); }
    else { div.appendChild(img); div.appendChild(speech); }
    container.appendChild(div);
    container.scrollTop = container.scrollHeight;
}

function checkGameOver() {
    if (gameState.neutralSeats <= 0) {
        let w = '';
        if (gameState.playerSeats > gameState.botSeats) w = 'ã‚ãªãŸã®æœ€çµ‚å‹åˆ©ï¼';
        else if (gameState.botSeats > gameState.playerSeats) w = 'é‡å…šã®å‹åˆ©ï¼';
        else w = 'å¼•ãåˆ†ã‘ï¼';
        document.getElementById('resultTitle').textContent = w;
        document.getElementById('gameOver').style.display = 'flex';
        return true;
    }
    return false;
}

function restartGame() { init(); }

function toggleBGM() {
    const bgm = document.getElementById("bgm");
    const btn = document.getElementById("bgmButton");
    if (!bgmEnabled) {
        bgm.play();
        bgmEnabled = true;
        btn.textContent = "ğŸ”‡ BGMã‚ªãƒ•";
    } else {
        bgm.pause();
        bgmEnabled = false;
        btn.textContent = "ğŸµ BGMã‚ªãƒ³";
    }
}

window.onload = init;
</script>
</body>
</html>